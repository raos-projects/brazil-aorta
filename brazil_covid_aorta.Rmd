---
title: "Brazilian Aortic Surgery Outcomes in COVID"
author: "Saieesh Rao"
date: "8/15/2024 - 9/23/2024"
output:
  html_notebook:
    toc: true
    number_sections: true
    toc_float:
      toc_collapsed: true

---
```{r, echo=FALSE, message=FALSE}
start_time <- Sys.time()
```


# Motivation
In this R notebook, we look at data on outcomes after aortic surgery in Brazil before and after the COVID-19 pandemic. Data used here is obtained from the Brazilian public health system which captures roughly ~70% of the Brazilian population. We investigate whether the COVID-19 pandemic adversely affected outcomes after aortic surgery during and after the pandemic.

# Setup
## Libraries
Import the necessary libraries:
```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(magrittr)
library(purrr)
library(tidyr)
library(epitools)
library(future)
library(furrr)
library(kableExtra)
library(blscrapeR)
library(ggplot2)
library(tibble)
library(rdd) # no longer in implementation, now using `rdrobust`
library(rdrobust)
```
## Data
We define a function to help us import the data:
```{r, message=FALSE, echo=FALSE}
# We have a number of ways to import the data. 
# 
# One way is to import data as a 2xN table where the two rows are pre-COVID and post-COVID, and the N columns are all combinations of the identifiers separated by underscores. This means the data has a lot of columns, and it will be easy to use methods which analyze the data when they are defined across many columns. The import function, 'import_flat', is defined below:

import_flat <- function(.type = c('Open','Endo')) {
  if(!(.type %in% c('Open','Endo'))) {
    warning('invalid type')
  }
  # .filepath = paste0("C:\\Users\\saiee\\OneDrive\\Documents\\_Northwestern Residency\\Research\\Miscellaneous Analyses\\Lopes, Lara\\Brazil COVID Stats ",
  #                   .type,".csv")
  .filepath = paste0("data\\Brazil COVID Stats ",.type,".csv")
  lara = read.csv(.filepath)
  
  lara %<>%
    mutate(PRE = Jan_2017_to_Feb_2020 %>% {gsub(',','',.)}) %>%
    mutate(POST = Mar_2020_to_Apr_2023 %>% {gsub(',','',.)}) %>%
    select(-c(Jan_2017_to_Feb_2020, Mar_2020_to_Apr_2023)) %>%
    mutate(TYPE = toupper(.type)) %>%
    t() %>%
    as_tibble()
  
  names(lara) <- lara %>%
    {paste(.[1,],.[2,],.[3,],.[6,])} %>%
    {gsub(' ','_',.)} %>%
    {gsub('-','_',.)}
  
  lara <- lara[-c(1:3,6),] %>%
    mutate(across(where(is.character), as.numeric))
  
  return(lara)
  
}
```

```{r, message=FALSE, echo=FALSE}
import <- function(.type = c('Open','Endo')) {
  if(!(.type %in% c('Open','Endo'))) {
    warning('invalid type')
  }
  # .filepath = paste0("C:\\Users\\saiee\\OneDrive\\Documents\\_Northwestern Residency\\Research\\Miscellaneous Analyses\\Lopes, Lara\\Brazil COVID Stats ", .type,".csv")
  .filepath = paste0("data\\Brazil COVID Stats ",.type,".csv")
  lara = read.csv(.filepath)
  
  lara %<>%
    mutate(PRE = Jan_2017_to_Feb_2020 %>% {gsub(',','',.)} %>% as.numeric()) %>%
    mutate(POST = Mar_2020_to_Apr_2023 %>% {gsub(',','',.)} %>% as.numeric()) %>%
    select(-c(Jan_2017_to_Feb_2020, Mar_2020_to_Apr_2023)) %>%
    mutate(TYPE = toupper(.type)) %>%
    as_tibble() %>%
    pivot_longer(cols = c(PRE,POST), names_to = 'PERIOD',values_to = 'VALUE')
  
  varnames <- lara %>% pull(VARIABLE) %>% unique()
  
  lara %<>%
    # filter(VARIABLE %in% c(FREQUENCY,DEATHS)) %>%
    pivot_wider(names_from = VARIABLE, values_from = VALUE) %>%
    mutate(ALIVE = FREQUENCY - DEATHS) %>%
    mutate(MORTALITY_ODDS = DEATHS / ALIVE) %>% 
    pivot_longer(cols = all_of(c(varnames,'ALIVE','MORTALITY_ODDS')), names_to = 'VARIABLE', values_to = 'VALUE')  %>%
    mutate(VARIABLE = as.factor(VARIABLE) %>% as.character(),
           TYPE = as.factor(TYPE) %>% as.character(),
           URGENCY = case_match(URGENCY, 'ALL' ~ 'ALL URGENCY', .default = URGENCY),
           POPULATION = case_match(POPULATION, 'GLOBAL' ~ 'ALL PEOPLE', .default = POPULATION))
  
  return(lara)
}
```

```{r, echo=FALSE}
import_bymonth <- function(.type = c('open','endo')) {
  if(!(.type %in% c('open','endo'))) {
    warning('invalid type')
  }
  .filepath = paste0("data\\brazil_aorta_", .type,"_bymonth.csv")
  lara_bymonth = read.csv(.filepath)
  
  lara_bymonth %<>%
    as_tibble()
  
  year_month_titles = lara_bymonth %>% names() %>% .[4:length(.)] %>% substr(start=2,stop=999) %>% as.factor()
  year_month_titles <- factor(year_month_titles, levels = year_month_titles)
  year_month_titles_trimmed = year_month_titles[1:120]
  
  names(lara_bymonth) <- lara_bymonth %>% names() %>% {c(.[1:3], .[4:length(.)]%>%substr(start=2,stop=999))}

    lara_bymonth %<>%
      pivot_longer(cols = {names(.)[4:length(names(.))]}, names_to = 'PERIOD', values_to = 'VALUE') %>% 
      mutate(PERIOD = factor(PERIOD, levels = year_month_titles)) %>% 
      mutate(VALUE = VALUE %>% as.numeric()) %>% 
      mutate(TYPE = toupper(.type)) %>% 
      mutate(POPULATION = POPULATION) %>% 
      filter(PERIOD %in% year_month_titles_trimmed)
  
  return(lara_bymonth)
}
```

```{r, message=FALSE, echo=FALSE}
# We next define a utility function, 'ob' (short for 'obtain') which allows us to extract the value of a metric from the table created by the 'import' function. This will save us a lot of time and provide clarity when we are repeatedly examining / extracting individual values:

ob <- function(.var, .pop, .urg, .type, .prepost) {
  lara %>%
    filter(VARIABLE %in% .var) %>%
    filter(POPULATION %in% .pop) %>%
    filter(URGENCY %in% .urg) %>%
    filter(TYPE %in% .type) %>%
    filter(PERIOD %in% .prepost) %>%
    pull() %>%
    as.numeric() %>% 
    sum()
}
```

```{r, message=FALSE, echo=FALSE}
# We define another utility function to tidy up the output from the epitools::oddsratio function:

or_prettyprint <- function(.output) {
  .output %>%
    unlist(recursive = FALSE) %>%
    {tribble(
      ~'OR', ~'lower', ~'upper', ~'p.value (chi.square)',
      .[['measure2']], .[['measure4']], .[['measure6']], .[['p.value6']]
    )} 
}
```

We now write a function to analyze the imported data. The output of this function is exactly one row in the resulting data table at the end of this file.
```{r, echo=FALSE}
# Ensure your 'lara' data frame is structured correctly
# The following script assumes 'lara' has columns: POPULATION, URGENCY, TYPE, PERIOD, VALUE

# Define a function to calculate odds ratios for specific comparisons
calculate_odds_ratio <- function(.population, .urgency, .type, .variable, ref_period = "PRE", new_period = "POST") {
  # Filter data for the specific subgroup, outcome, and comparison
  # and arrange so that the comparison is in the order of the inputted
  # parameters (e.g., ENDO vs OPEN is the inverse of OPEN vs ENDO)
  df_filtered <- lara %>%
    filter(POPULATION %in% .population,
           URGENCY %in% .urgency,
           TYPE %in% .type,
           VARIABLE %in% .variable) %>% 
    arrange(match(POPULATION, .population),
            match(URGENCY, .urgency),
            match(TYPE, .type),
            match(VARIABLE, .variable))
  
  # Create a contingency table for the specified periods
  contingency_table <- matrix(c(
    df_filtered$VALUE[df_filtered$PERIOD == ref_period],
    df_filtered$VALUE[df_filtered$PERIOD == new_period]
  ), ncol = 2, byrow = TRUE)
  
  # Calculate the odds ratio using epitools::oddsratio
  tryCatch(
    {
      or_result <<- oddsratio(contingency_table)
    },
    error=function (e){
      or_result <<- list(measure = tibble(), p.value = tibble())
      or_result$measure <<- tribble(
        ~estimate, ~upper, ~lower,
        NA, NA, NA,
        NA, NA, NA,
      )
      or_result$p.value <<- tribble(
        ~midp.exact,
        NA,
        NA
      )
    }
  )
  
  # Extract the odds ratio and confidence interval
  or_value <- or_result$measure[2, "estimate"]^-1 #inverse for post/pre
  ci_lower <- or_result$measure[2, "upper"]^-1
  ci_upper <- or_result$measure[2, "lower"]^-1
  p_value <- or_result$p.value[2, "midp.exact"]
  
  #comparison group is the one with more than one value passed as a parameter
  params <- list(.population, .urgency, .type)
  comparison <- params %>%
    lapply(length) %>%
    lapply(function(.x){return(.x > 1)}) %>% 
    unlist() %>% 
    {params[which(.)]} %>% 
    unlist()
  controls <- params %>%
    lapply(length) %>%
    lapply(function(.x){return(.x == 1)}) %>% 
    unlist() %>% 
    {params[which(.)]} %>% 
    unlist() 
  
  return(data.frame(
    Metric = paste(.variable,collapse = '/'),
    Population = paste(controls, collapse = ', '),
    Comparison = case_when(length(comparison) > 1 ~ paste(comparison[1], "vs.", comparison[2]),
                           .default = 'DEATHS vs. ALIVE'),
    Odds_Pre = contingency_table[1,1]/contingency_table[1,2],
    Odds_Post = contingency_table[2,1]/contingency_table[2,2],
    Odds_Ratio = round(or_value, 2),
    CI_95 = paste0("(", round(ci_lower, 2), ", ", round(ci_upper, 2), ")"),
    P_Value = round(p_value, 4),
    Significance = case_when(p_value <= 0.001 ~ '***',
                             p_value <= 0.01 ~ '**',
                             p_value <= 0.05 ~ '*',
                             p_value <= 0.1 ~ '.',
                             .default = '')
  ))
}
```
We now write a quick linear regression function, with output as one row in a table (or two rows if calculating regressions on both sides of a discontinuity). First, a function to quickly filter data based on parameters:
```{r, echo=FALSE}
# filter data to the specified parameters
quick_filter <- function(.data, .variable, .population, .urgency, .type) {
  .data %<>% 
    filter(VARIABLE %in% .variable) %>% 
    filter(!is.na(PERIOD)) %>% 
    filter(POPULATION %in% .population) %>% 
    filter(URGENCY %in% .urgency) %>% 
    filter(TYPE %in% .type) %>% 
    mutate(TIME = as.integer(PERIOD))
  return(.data)
}
```

Utility function for generating linear models, either for summarizing linear results or outputting result of regression discontinuity design:
```{r, echo=FALSE}
lm_quick <- function(.data, .variable, .population, .urgency, .type, .predict){
  
  # use `rdd` package to determine best fit regressions on each side of the discontinuity.
  # N.B. this now deprecated in favor of the `rdrobust` implementation `lm_quick_rdrobust`
  lm_quick_rdd <- function(.data, .variable, .population, .urgency, .type, .predict) {
    
    .data %<>% quick_filter(.variable, .population, .urgency, .type)
    
    rd_model <- RDestimate(VALUE ~ TIME, data = .data, cutpoint = .predict, kernel = 'uniform')
    
    intercept <- rd_model$model[[1]]$coefficients[["(Intercept)"]]
    treatment_effect <- rd_model$model[[1]]$coefficients[["Tr"]]
    slope_left <- rd_model$model[[1]]$coefficients[["Xl"]]
    slope_right <- rd_model$model[[1]]$coefficients[["Xr"]]
    p_value <- rd_model$p[1]
    
    intercept_left = intercept - slope_left * .predict
    intercept_right = intercept + treatment_effect - slope_right * .predict
    
    IKB <- rd_model$bw[1] #Imbens-Kalyanaraman bandwidth
    .data$PREDICTED = NaN
    .data$PREDICTED = case_when(.data$TIME < .predict ~ intercept_left + slope_left * .data$TIME,
                                .data$TIME > .predict ~ intercept_right + slope_right * .data$TIME,
                                .default = NA)
    
    output_table <-
      tribble(
        ~VARIABLE, ~POPULATION, ~URGENCY, ~TYPE, ~Intercept, ~Coefficient, ~PERIOD, ~TREATMENT_EFFECT, ~P.VALUE, ~IK.BANDWIDTH,
        .variable, .population, .urgency, .type, intercept_left, slope_left, 'PRE', NA, NA, IKB,
        .variable, .population, .urgency, .type, intercept_right, slope_right, 'POST', treatment_effect, p_value ,IKB
      )

    return(list(row = output_table, newdata = .data, bw = IKB))
  }
  
  # use `rdrobust` package to determine best fit regressions on each side of the continuity.
  # this is the preferred method within `lm_quick` given the calculation of bias corrected
  # and robust inference measures in the `rdrobust` package. Predicted values and standard
  # errors of those predictions are returned so that regression lines may be plotted with
  # confidence intervals shaded similar to geom_smooth(method = 'lm')
  lm_quick_rdrobust <- function(.data, .variable, .population, .urgency, .type, .predict) {
    
    .data_all <- .data %>%  quick_filter(.variable, .population, .urgency, .type)
    
    output = list(row=list(), newdata=list(), bw=list(), pred_left=list(), pred_right=list())
    
    for(var_ in .variable){
      for(pop_ in .population){
        for(urg_ in .urgency){
          for(typ_ in .type){
            .data <- .data_all %>% quick_filter(var_, pop_, urg_, typ_)
            
            rd_model <- rdrobust(y = .data$VALUE, x = .data$TIME, c = .predict, p = 1, kernel = 'uniform')
            
            rd_bandwidth = rd_model$bws[[1,1]]
            tau_cl = rd_model$Estimate[[1]]
            tau_bc = rd_model$Estimate[[2]]
            
            cutoff_left = rd_model$beta_Y_p_l[[1]]
            slope_left = rd_model$beta_Y_p_l[[2]]
            intercept_left = cutoff_left - slope_left*.predict
            time_left = seq(ceiling(.predict - rd_bandwidth), .predict-1)
            period_left = .data$PERIOD[time_left]
            
            cutoff_right = rd_model$beta_Y_p_r[[1]]
            slope_right = rd_model$beta_Y_p_r[[2]]
            intercept_right = cutoff_right - slope_right*.predict
            time_right = seq(.predict, floor(.predict + rd_bandwidth))
            period_right = .data$PERIOD[time_right]
            
            p_value_cl <- rd_model$pv[[1]]
            p_value_bc <- rd_model$pv[[2]]
            p_value_robust <- rd_model$pv[[3]]
            
            lm_left = lm(VALUE ~ TIME, data = .data %>% subset(TIME > .predict - rd_bandwidth & TIME < .predict))
            lm_right = lm(VALUE ~ TIME, data = .data %>% subset(TIME < .predict + rd_bandwidth & TIME >= .predict))
            
            .pred_left <-
              predict(lm_left, newdata = data.frame(TIME = seq(ceiling(.predict - rd_bandwidth), .predict-1)), se.fit = TRUE) %>% 
              {data.frame(TIME = time_left, PERIOD = period_left,
                          VALUE = .$fit, LOWER = .$fit - 1.96*.$se.fit, UPPER = .$fit + 1.96*.$se.fit,
                          URGENCY = urg_, TYPE = typ_, POPULATION = pop_, VARIABLE = var_)}
            .pred_right <- 
              predict(lm_right, newdata = data.frame(TIME = seq(.predict,floor(.predict + rd_bandwidth))), se.fit = TRUE) %>% 
              {data.frame(TIME = time_right, PERIOD = period_right,
                          VALUE = .$fit, LOWER = .$fit - 1.96*.$se.fit, UPPER = .$fit + 1.96*.$se.fit,
                          URGENCY = urg_, TYPE = typ_, POPULATION = pop_, VARIABLE = var_)}
            
            pstar <- function(p_value) {
              return(case_when(p_value <= 0.001 ~ '***',
                             p_value <= 0.01 ~ '**',
                             p_value <= 0.05 ~ '*',
                             p_value <= 0.1 ~ '.',
                             .default = ''))
            }
            
            output_table <-
              tribble(
                ~VARIABLE, ~POPULATION, ~URGENCY, ~TYPE, ~Intercept, ~Coefficient, ~PERIOD, ~τ_conv, ~PV_conv, ~τ_bc, ~PV_bc, ~PV_robust, ~BANDWIDTH,
                var_, pop_, urg_, typ_, intercept_left, slope_left, 'PRE', '', pstar(p_value_cl), '', pstar(p_value_bc), pstar(p_value_robust), rd_bandwidth,
                var_, pop_, urg_, typ_, intercept_right, slope_right, 'POST', as.character(round(tau_cl,3)), as.character(round(p_value_cl,3)), as.character(round(tau_bc,3)), as.character(round(p_value_bc,3)), as.character(round(p_value_robust,3)) ,rd_bandwidth
              )
            
            output$row %<>% bind_rows(output_table)
            output$newdata %<>% bind_rows(.data) 
            output$bw %<>% append(rd_bandwidth)
            output$pred_left %<>% bind_rows(.pred_left)
            output$pred_right %<>% bind_rows(.pred_right)
          }
        }
      }
    }
    return(output)
  }
  
  # use base R 'lm' function and IKbandwidth from `rdd` to manually calculate best fit regressions
  # on each side of the continuity. This is deprecated now that we use the `rdrobust` package to
  # calculate bias corrected and robust inference measures (see `lm_quick_rdrobust`)
  lm_quick_manual <- function(.data, .variable, .population, .urgency, .type, .predict) {
    .data %<>% quick_filter(.variable, .population, .urgency, .type)
    
    .ikb = IKbandwidth(.data$TIME, .data$VALUE, cutpoint = 75, kernel = 'rectangular')
    
    lm_left <- .data %>% subset(TIME < 75 & TIME > 75 - .ikb) %>%
      lm_quick_core(.variable, .population, .urgency, .type)
    
    lm_right <- .data %>% subset(TIME > 75 & TIME < 75 + .ikb) %>%
      lm_quick_core(.variable, .population, .urgency, .type)
    
    pred_left = predict(lm_left$model, newdata = data.frame(TIME = .predict), se.fit = TRUE)
    pred_right = predict(lm_right$model, newdata = data.frame(TIME = .predict), se.fit = TRUE)
    
    treatment_effect = pred_right$fit - pred_left$fit
    se_treatment_effect = sqrt(pred_right$se.fit^2 + pred_left$se.fit^2)
    z_value = treatment_effect / se_treatment_effect
    p_value <- 2 * (1 - pnorm(abs(z_value)))
    
    lm_left$row %<>% mutate(TREATMENT_EFFECT = NA, P.VALUE = NA, IK.BANDWIDTH = .ikb)
    lm_right$row %<>% mutate(TREATMENT_EFFECT = treatment_effect, P.VALUE = p_value, IK.BANDWIDTH = .ikb)
    
    return(list(row = bind_rows(lm_left$row, lm_right$row), newdata = .data, ikb = .ikb))
  }
  
  # run a basic OLS regression after filtering on the given parameters
  lm_quick_core <- function(.data, .variable, .population, .urgency, .type) {
    reg <- .data %>% 
      quick_filter(.variable, .population, .urgency, .type) %>% 
      mutate(TIME = as.integer(PERIOD)) %>%
      {lm(VALUE ~ TIME,.)}
    
    output <- 
      tribble(
        ~VARIABLE, ~POPULATION, ~URGENCY, ~TYPE, ~Intercept, ~Coefficient, ~R2, ~R2_adjusted,
        .variable, .population, .urgency, .type, reg$coefficients %>% .['(Intercept)'], reg$coefficients %>% .['TIME'], summary(reg)[['r.squared']], summary(reg)[['adj.r.squared']]
      )
    
    return(list(row = output, model = reg))
  }
  
  if(is.numeric(.predict)) {
    return(lm_quick_rdrobust(.data, .variable, .population, .urgency, .type, .predict))
  } else {
    return(lm_quick_core(.data, .variable, .population, .urgency, .type) %>% .[['row']])
  }
}
```


Since we wil be using a lot of variables of the same name across code chunks, I write a function to clean them up before starting a new code chunk (prevents logical errors from typos):
```{r, echo=FALSE}
cleanup <- function(){
  ls(pattern = '^IKB_', envir = .GlobalEnv) %>% {rm(list = ., envir = .GlobalEnv)}
  ls(pattern = '^lara_bymonth_', envir = .GlobalEnv) %>% {rm(list = ., envir = .GlobalEnv)}
  ls(pattern = '^table_row_', envir = .GlobalEnv) %>% {rm(list = ., envir = .GlobalEnv)}
  ls(pattern = '^pred_', envir = .GlobalEnv) %>% {rm(list = ., envir = .GlobalEnv)}
  ls(pattern = '^total_preds_', envir = .GlobalEnv) %>% {rm(list = ., envir = .GlobalEnv)}
}
```


# Analysis
## Import Data
Lets now actually import both the open surgery and endovascular surgery data sets, and join them in one big table:
```{r, echo=FALSE}
lara <- bind_rows(import('Open'),
                  import('Endo'))  %>% 
  pivot_wider(names_from = 'TYPE', values_from = 'VALUE') %>% 
  mutate(`ALL APPROACH` = ENDO + OPEN) %>%
  pivot_longer(cols = c('ALL APPROACH','ENDO','OPEN'), names_to = 'TYPE', values_to = 'VALUE')
```

We create a data frame with all possible combinations of parameters that can define two groups we want to compare:
```{r, echo=FALSE}
# Define the subgroups, outcomes, and comparisons you want to analyze

params_combo <- expand.grid(.population = list('ALL PEOPLE','MALE','FEMALE',c('MALE','FEMALE'),
                            'WHITE','BLACK','PARDA',
                            c('WHITE','BLACK'),c('WHITE','PARDA'),c('BLACK','PARDA')),
                      .urgency = list('ALL URGENCY','URGENT','ELECTIVE',c('URGENT','ELECTIVE')),
                      .type = list('ALL APPROACH','ENDO','OPEN',c('ENDO','OPEN')),
                      .variable = list('FREQUENCY',c('DEATHS','ALIVE')))
```

We narrow these combinations, so that there is only one parameter with two values; these two values will be the subgroups for comparison along with pre-COVID vs. post-COVID comparisons:
```{r, echo=FALSE}
params_filtered <- params_combo %>%
  rowwise() %>% 
  mutate(across(everything(),
                .fns = ~length(.x),
                .names = '{.col}_n')) %>% 
  filter(.population_n + .urgency_n + .type_n + .variable_n == 5) %>% #.variable_n
  select(-ends_with('_n'))

#calculate odds ratios with parallel computing
plan(multicore, workers = 3)

output <- future_pmap(params_filtered, calculate_odds_ratio, .progress = TRUE)
output %<>% bind_rows() %>% select(-c('estimate','midp.exact'))

output %>% 
  kbl() %>% 
  kable_classic() %>% 
  row_spec(lapply(seq(0,(dim(output)[1]-1)/18),
                  function(.x) {c(4 + 18*.x, 8+18*.x, 12 + 18*.x, 18 + 18*.x)}) %>% unlist(),
           extra_css = "border-bottom: 1px solid")
```

# Bar Charts
Let's now create the requested figures. First let's import the data in by month format, and add a third `TYPE` category combining `OPEN` and `ENDO` called `ALL`:
```{r, warning=FALSE, message=FALSE, echo=FALSE}
lara_bymonth <- bind_rows(import_bymonth('open'),
                          import_bymonth('endo'))
variable_names <- lara_bymonth$VARIABLE %>% unique()
lara_bymonth %<>% 
  pivot_wider(names_from = TYPE, values_from = VALUE) %>% 
  mutate(ALL = OPEN + ENDO) %>% 
  pivot_longer(cols = c('OPEN','ENDO','ALL'), names_to = 'TYPE') %>%
  rename(VALUE = value) %>% 
  pivot_wider(names_from = VARIABLE, values_from = VALUE) %>% 
  mutate(DEATHS = ifelse(is.na(DEATHS), 0, DEATHS)) %>% 
  mutate(MORTALITY = DEATHS / FREQUENCY * 100) %>% 
  mutate(MORTALITY = ifelse(is.nan(MORTALITY), 0, MORTALITY)) %>% 
  pivot_longer(cols = variable_names, names_to = 'VARIABLE') %>% 
  rename(VALUE = value)
```

## FREQUENCY
```{r, echo=FALSE}
cleanup()
lara_bymonth %>%
  filter(VARIABLE == 'FREQUENCY') %>%
  filter(!is.na(PERIOD)) %>% 
  filter(POPULATION == 'GLOBAL') %>% 
  filter(URGENCY != 'ALL') %>% 
  filter(TYPE != 'ALL') %>% 
  group_by(URGENCY, TYPE) %>%
  ggplot(aes(x=PERIOD, y=VALUE, fill = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_bar(position = 'stack', stat='identity') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', fill='URGENCY and TYPE')
```

```{r, echo=FALSE}
cleanup()
lara_bymonth %>%
  filter(VARIABLE == 'FREQUENCY') %>%
  filter(!is.na(PERIOD)) %>% 
  filter(POPULATION == 'GLOBAL') %>% 
  filter(URGENCY != 'ALL') %>% 
  filter(TYPE != 'ALL') %>% 
  group_by(URGENCY, TYPE) %>%
  ggplot(aes(x=PERIOD, y=VALUE, fill = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_bar(position = 'fill', stat='identity') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', fill='URGENCY and TYPE')
```
# Scatter Plots and Regressions
## FREQUENCY
Here we look at the data on each side of the COVID pandemic start date and examine for discontinuity at the start of COVID. First we examine `FREQUENCY` data for both `URGENCY` and `TYPE`: 
```{r, echo=FALSE, warning=FALSE}
cleanup()
lara_bymonth_urgent_all = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','URGENT','ALL',75)
table_row_urgent_all = lara_bymonth_urgent_all[['row']]
BW_urgent_all = lara_bymonth_urgent_all[['bw']]
pred_left_urgent_all = lara_bymonth_urgent_all[['pred_left']]
pred_right_urgent_all = lara_bymonth_urgent_all[['pred_right']]
lara_bymonth_urgent_all = lara_bymonth_urgent_all[['newdata']]

lara_bymonth_elective_all = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','ELECTIVE','ALL',75)
table_row_elective_all = lara_bymonth_elective_all[['row']]
BW_elective_all = lara_bymonth_elective_all[['bw']]
pred_left_elective_all = lara_bymonth_elective_all[['pred_left']]
pred_right_elective_all = lara_bymonth_elective_all[['pred_right']]
lara_bymonth_elective_all = lara_bymonth_elective_all[['newdata']]

lara_bymonth_urgent_open = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','URGENT','OPEN',75)
table_row_urgent_open = lara_bymonth_urgent_open[['row']]
BW_urgent_open = lara_bymonth_urgent_open[['bw']]
pred_left_urgent_open = lara_bymonth_urgent_open[['pred_left']]
pred_right_urgent_open = lara_bymonth_urgent_open[['pred_right']]
lara_bymonth_urgent_open = lara_bymonth_urgent_open[['newdata']]

lara_bymonth_elective_open = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','ELECTIVE','OPEN',75)
table_row_elective_open = lara_bymonth_elective_open[['row']]
BW_elective_open = lara_bymonth_elective_open[['bw']]
pred_left_elective_open = lara_bymonth_elective_open[['pred_left']]
pred_right_elective_open = lara_bymonth_elective_open[['pred_right']]
lara_bymonth_elective_open = lara_bymonth_elective_open[['newdata']]

lara_bymonth_urgent_endo = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','URGENT','ENDO',75)
table_row_urgent_endo = lara_bymonth_urgent_endo[['row']]
BW_urgent_endo = lara_bymonth_urgent_endo[['bw']]
pred_left_urgent_endo = lara_bymonth_urgent_endo[['pred_left']]
pred_right_urgent_endo = lara_bymonth_urgent_endo[['pred_right']]
lara_bymonth_urgent_endo = lara_bymonth_urgent_endo[['newdata']]

lara_bymonth_elective_endo = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','ELECTIVE','ENDO',75)
table_row_elective_endo = lara_bymonth_elective_endo[['row']]
BW_elective_endo = lara_bymonth_elective_endo[['bw']]
pred_left_elective_endo = lara_bymonth_elective_endo[['pred_left']]
pred_right_elective_endo = lara_bymonth_elective_endo[['pred_right']]
lara_bymonth_elective_endo = lara_bymonth_elective_endo[['newdata']]

lara_bymonth_all_endo = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','ALL','ENDO',75)
table_row_all_endo = lara_bymonth_all_endo[['row']]
BW_all_endo = lara_bymonth_all_endo[['bw']]
pred_left_all_endo = lara_bymonth_all_endo[['pred_left']]
pred_right_all_endo = lara_bymonth_all_endo[['pred_right']]
lara_bymonth_all_endo = lara_bymonth_all_endo[['newdata']]

lara_bymonth_all_open = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','ALL','OPEN',75)
table_row_all_open = lara_bymonth_all_open[['row']]
BW_all_open = lara_bymonth_all_open[['bw']]
pred_left_all_open = lara_bymonth_all_open[['pred_left']]
pred_right_all_open = lara_bymonth_all_open[['pred_right']]
lara_bymonth_all_open = lara_bymonth_all_open[['newdata']]

lara_bymonth_all_all = lara_bymonth %>%
  lm_quick('FREQUENCY','GLOBAL','ALL','ALL',75)
table_row_all_all = lara_bymonth_all_all[['row']]
BW_all_all = lara_bymonth_all_all[['bw']]
pred_left_all_all = lara_bymonth_all_all[['pred_left']]
pred_right_all_all = lara_bymonth_all_all[['pred_right']]
lara_bymonth_all_all = lara_bymonth_all_all[['newdata']]
```
### URGENCY and TYPE
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ URGENCY + TYPE
ggplot(bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo),aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and TYPE')

# simple LOESS over the entire study period, URGENCY and TYPE combos
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and TYPE')

# simple OLS over the entire study period, URGENCY and TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and TYPE')

expand_grid(.variable = 'FREQUENCY',
            .population = 'GLOBAL',
            .urgency = c('URGENT','ELECTIVE'),
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY and TYPE combos
total_preds_left = bind_rows(
  pred_left_urgent_open, pred_left_urgent_endo, pred_left_elective_open, pred_left_elective_endo
  )

total_preds_right = bind_rows(
  pred_right_urgent_open, pred_right_urgent_endo, pred_right_elective_open, pred_right_elective_endo
  )

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and TYPE')

list(table_row_urgent_open, table_row_elective_open, table_row_urgent_endo, table_row_elective_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### URGENCY only
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ URGENCY
ggplot(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency',color='URGENCY')

# simple LOESS over the study period, URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = URGENCY)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY')

# simple OLS over the entire study period, URGENCY and all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = URGENCY)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY')

expand_grid(.variable = 'FREQUENCY',
            .population = 'GLOBAL',
            .urgency = c('URGENT','ELECTIVE'),
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY with all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_ribbon(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = URGENCY), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, y = VALUE, color = URGENCY, group = URGENCY), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = URGENCY), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, y = VALUE, color = URGENCY, group = URGENCY), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME < 75 & TIME > 75 - IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME > 75 & TIME < 75 + IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME < 75 & TIME > 75 - IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME > 75 & TIME < 75 + IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY')

list(table_row_urgent_all, table_row_elective_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
  
# FREQUENCY by ALL, URGENT, ELECTIVE
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

expand.grid(list(.variable = 'FREQUENCY',
                 .population = 'GLOBAL',
                 .urgency = c('ALL','URGENT','ELECTIVE'),
                 .type = c('ALL'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()
```
### TYPE only
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ TYPE
ggplot(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE')

#simple LOESS over the study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE')

# simple OLS over the entire study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE')

expand_grid(.variable = 'FREQUENCY',
            .population = 'GLOBAL',
            .urgency = 'ALL',
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to IK bandwidth about the cut point, TYPE with all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_ribbon(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE')

list(table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# FREQUENCY by ALL, ENDO, OPEN
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

expand.grid(list(.variable = 'FREQUENCY',
                 .population = 'GLOBAL',
                 .urgency = 'ALL',
                 .type = c('ALL','OPEN','ENDO'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()

# regression discontinuity FREQUENCY ~ TYPE (including ALL)
total_preds_left = bind_rows(
  pred_left_all_all, pred_left_all_endo, pred_left_all_open
  )

total_preds_right = bind_rows(
  pred_right_all_all, pred_right_all_endo, pred_right_all_open
  )

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE')

list(table_row_all_all, table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### Entire Population
```{r, message=FALSE, echo=FALSE}
# simple LOESS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE)) + #, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE)) + #, colour = interaction(URGENCY,TYPE)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

# simple OLS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE)) + #, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE)) + #, colour = interaction(URGENCY,TYPE)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

expand_grid(.variable = 'FREQUENCY',
            .population = 'GLOBAL',
            .urgency = 'ALL',
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, group = interaction(URGENCY,TYPE))) + 
  geom_ribbon(data = pred_left_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_left_all_all, aes(x = PERIOD, y = VALUE, group = interaction(URGENCY,TYPE)), linewidth = 1.25, color = 'blue') +
  geom_ribbon(data = pred_right_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_right_all_all, aes(x = PERIOD, y = VALUE, group = interaction(URGENCY,TYPE)), color = 'blue', linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

list(table_row_all_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```

## MORTALITY
Next we examine `MORTALITY` data for both `URGENCY` and `TYPE` and look for discontinuity at the start of COVID: 
```{r, echo=FALSE, warning=FALSE}
cleanup()
lara_bymonth_urgent_all = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','URGENT','ALL',75)
table_row_urgent_all = lara_bymonth_urgent_all[['row']]
BW_urgent_all = lara_bymonth_urgent_all[['bw']]
pred_left_urgent_all = lara_bymonth_urgent_all[['pred_left']]
pred_right_urgent_all = lara_bymonth_urgent_all[['pred_right']]
lara_bymonth_urgent_all = lara_bymonth_urgent_all[['newdata']]

lara_bymonth_elective_all = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','ELECTIVE','ALL',75)
table_row_elective_all = lara_bymonth_elective_all[['row']]
BW_elective_all = lara_bymonth_elective_all[['bw']]
pred_left_elective_all = lara_bymonth_elective_all[['pred_left']]
pred_right_elective_all = lara_bymonth_elective_all[['pred_right']]
lara_bymonth_elective_all = lara_bymonth_elective_all[['newdata']]

lara_bymonth_urgent_open = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','URGENT','OPEN',75)
table_row_urgent_open = lara_bymonth_urgent_open[['row']]
BW_urgent_open = lara_bymonth_urgent_open[['bw']]
pred_left_urgent_open = lara_bymonth_urgent_open[['pred_left']]
pred_right_urgent_open = lara_bymonth_urgent_open[['pred_right']]
lara_bymonth_urgent_open = lara_bymonth_urgent_open[['newdata']]

lara_bymonth_elective_open = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','ELECTIVE','OPEN',75)
table_row_elective_open = lara_bymonth_elective_open[['row']]
BW_elective_open = lara_bymonth_elective_open[['bw']]
pred_left_elective_open = lara_bymonth_elective_open[['pred_left']]
pred_right_elective_open = lara_bymonth_elective_open[['pred_right']]
lara_bymonth_elective_open = lara_bymonth_elective_open[['newdata']]

lara_bymonth_urgent_endo = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','URGENT','ENDO',75)
table_row_urgent_endo = lara_bymonth_urgent_endo[['row']]
BW_urgent_endo = lara_bymonth_urgent_endo[['bw']]
pred_left_urgent_endo = lara_bymonth_urgent_endo[['pred_left']]
pred_right_urgent_endo = lara_bymonth_urgent_endo[['pred_right']]
lara_bymonth_urgent_endo = lara_bymonth_urgent_endo[['newdata']]

lara_bymonth_elective_endo = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','ELECTIVE','ENDO',75)
table_row_elective_endo = lara_bymonth_elective_endo[['row']]
BW_elective_endo = lara_bymonth_elective_endo[['bw']]
pred_left_elective_endo = lara_bymonth_elective_endo[['pred_left']]
pred_right_elective_endo = lara_bymonth_elective_endo[['pred_right']]
lara_bymonth_elective_endo = lara_bymonth_elective_endo[['newdata']]

lara_bymonth_all_endo = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','ALL','ENDO',75)
table_row_all_endo = lara_bymonth_all_endo[['row']]
BW_all_endo = lara_bymonth_all_endo[['bw']]
pred_left_all_endo = lara_bymonth_all_endo[['pred_left']]
pred_right_all_endo = lara_bymonth_all_endo[['pred_right']]
lara_bymonth_all_endo = lara_bymonth_all_endo[['newdata']]

lara_bymonth_all_open = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','ALL','OPEN',75)
table_row_all_open = lara_bymonth_all_open[['row']]
BW_all_open = lara_bymonth_all_open[['bw']]
pred_left_all_open = lara_bymonth_all_open[['pred_left']]
pred_right_all_open = lara_bymonth_all_open[['pred_right']]
lara_bymonth_all_open = lara_bymonth_all_open[['newdata']]

lara_bymonth_all_all = lara_bymonth %>%
  lm_quick('MORTALITY','GLOBAL','ALL','ALL',75)
table_row_all_all = lara_bymonth_all_all[['row']]
BW_all_all = lara_bymonth_all_all[['bw']]
pred_left_all_all = lara_bymonth_all_all[['pred_left']]
pred_right_all_all = lara_bymonth_all_all[['pred_right']]
lara_bymonth_all_all = lara_bymonth_all_all[['newdata']]
```
### URGENCY and TYPE
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ URGENCY + TYPE
ggplot(bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo),aes(x=PERIOD, y=VALUE/100, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

# simple LOESS over the entire study period, URGENCY and TYPE combos
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE/100, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE/100, colour = interaction(URGENCY,TYPE))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

# simple OLS over the entire study period, URGENCY and TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE/100, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE/100, colour = interaction(URGENCY,TYPE))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

expand_grid(.variable = 'MORTALITY',
            .population = 'GLOBAL',
            .urgency = c('URGENT','ELECTIVE'),
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY and TYPE combos
total_preds_left = bind_rows(
  pred_left_urgent_open, pred_left_urgent_endo, pred_left_elective_open, pred_left_elective_endo
)

total_preds_right = bind_rows(
  pred_right_urgent_open, pred_right_urgent_endo, pred_right_elective_open, pred_right_elective_endo
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE/100, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE/100, color = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE/100, color = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

list(table_row_urgent_open, table_row_elective_open, table_row_urgent_endo, table_row_elective_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### URGENCY only
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ URGENCY
ggplot(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE/100, colour = URGENCY, group = URGENCY)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality',color='URGENCY')

# simple LOESS over the study period, URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE/100, colour = URGENCY, group = URGENCY)) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE/100, colour = URGENCY)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY')

# simple OLS over the entire study period, URGENCY and all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE/100, colour = URGENCY, group = URGENCY)) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE/100, colour = URGENCY)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY')

expand_grid(.variable = 'MORTALITY',
            .population = 'GLOBAL',
            .urgency = c('URGENT','ELECTIVE'),
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY with all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE/100, colour = URGENCY, group = URGENCY)) +
  geom_ribbon(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = URGENCY), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, y = VALUE/100, color = URGENCY, group = URGENCY), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = URGENCY), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, y = VALUE/100, color = URGENCY, group = URGENCY), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME < 75 & TIME > 75 - IKB_urgent_all), aes(x=TIME, y=VALUE/100, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME > 75 & TIME < 75 + IKB_urgent_all), aes(x=TIME, y=VALUE/100, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME < 75 & TIME > 75 - IKB_elective_all), aes(x=TIME, y=VALUE/100, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME > 75 & TIME < 75 + IKB_elective_all), aes(x=TIME, y=VALUE/100, color=URGENCY), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY')

list(table_row_urgent_all, table_row_elective_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# MORTALITY by ALL, URGENT, ELECTIVE
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE/100, colour = URGENCY, group = URGENCY)) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE/100, colour = URGENCY, group = URGENCY)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

expand.grid(list(.variable = 'MORTALITY',
                 .population = 'GLOBAL',
                 .urgency = c('ALL','URGENT','ELECTIVE'),
                 .type = c('ALL'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()
```
### TYPE only
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ TYPE
ggplot(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE/100, colour = TYPE, group = TYPE)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

#simple LOESS over the study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE/100, colour = TYPE, group = TYPE)) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE/100, colour = TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

# simple OLS over the entire study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE/100, colour = TYPE, group = TYPE)) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE/100, colour = TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

expand_grid(.variable = 'MORTALITY',
            .population = 'GLOBAL',
            .urgency = 'ALL',
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to IK bandwidth about the cut point, TYPE with all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE/100, colour = TYPE, group = TYPE)) +
  geom_ribbon(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, y = VALUE/100, color = TYPE, group = TYPE), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, y = VALUE/100, color = TYPE, group = TYPE), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

list(table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# MORTALITY by ALL, ENDO, OPEN
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE/100, colour = TYPE, group = TYPE)) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE/100, colour = TYPE, group = TYPE)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

expand.grid(list(.variable = 'MORTALITY',
                 .population = 'GLOBAL',
                 .urgency = 'ALL',
                 .type = c('ALL','OPEN','ENDO'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()

# regression discontinuity MORTALITY ~ TYPE (including ALL)
total_preds_left = bind_rows(
  pred_left_all_all, pred_left_all_endo, pred_left_all_open
)

total_preds_right = bind_rows(
  pred_right_all_all, pred_right_all_endo, pred_right_all_open
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE/100, colour = TYPE, group = TYPE)) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE/100, color = TYPE, group = TYPE), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE/100, color = TYPE, group = TYPE), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE/100, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

list(table_row_all_all, table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### Entire Population
```{r, message=FALSE, echo=FALSE}
# simple LOESS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE)) + #, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE)) + #, colour = interaction(URGENCY,TYPE)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

# simple OLS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE)) + #, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE)) + #, colour = interaction(URGENCY,TYPE)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

expand_grid(.variable = 'MORTALITY',
            .population = 'GLOBAL',
            .urgency = 'ALL',
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE/100, group = interaction(URGENCY,TYPE))) + 
  geom_ribbon(data = pred_left_all_all, aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_left_all_all, aes(x = PERIOD, y = VALUE/100, group = interaction(URGENCY,TYPE)), linewidth = 1.25, color = 'blue') +
  geom_ribbon(data = pred_right_all_all, aes(x = PERIOD, ymin = LOWER/100, ymax = UPPER/100, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_right_all_all, aes(x = PERIOD, y = VALUE/100, group = interaction(URGENCY,TYPE)), color = 'blue', linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

list(table_row_all_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```

## FREQUENCY with RACE
Filter by most represented racial groups:
```{r, message=FALSE, echo=FALSE}
cleanup()
lara_bymonth_urgent_all = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'URGENT','ALL',75)
table_row_urgent_all = lara_bymonth_urgent_all[['row']]
BW_urgent_all = lara_bymonth_urgent_all[['bw']]
pred_left_urgent_all = lara_bymonth_urgent_all[['pred_left']]
pred_right_urgent_all = lara_bymonth_urgent_all[['pred_right']]
lara_bymonth_urgent_all = lara_bymonth_urgent_all[['newdata']]

lara_bymonth_elective_all = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ELECTIVE','ALL',75)
table_row_elective_all = lara_bymonth_elective_all[['row']]
BW_elective_all = lara_bymonth_elective_all[['bw']]
pred_left_elective_all = lara_bymonth_elective_all[['pred_left']]
pred_right_elective_all = lara_bymonth_elective_all[['pred_right']]
lara_bymonth_elective_all = lara_bymonth_elective_all[['newdata']]

lara_bymonth_urgent_open = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'URGENT','OPEN',75)
table_row_urgent_open = lara_bymonth_urgent_open[['row']]
BW_urgent_open = lara_bymonth_urgent_open[['bw']]
pred_left_urgent_open = lara_bymonth_urgent_open[['pred_left']]
pred_right_urgent_open = lara_bymonth_urgent_open[['pred_right']]
lara_bymonth_urgent_open = lara_bymonth_urgent_open[['newdata']]

lara_bymonth_elective_open = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ELECTIVE','OPEN',75)
table_row_elective_open = lara_bymonth_elective_open[['row']]
BW_elective_open = lara_bymonth_elective_open[['bw']]
pred_left_elective_open = lara_bymonth_elective_open[['pred_left']]
pred_right_elective_open = lara_bymonth_elective_open[['pred_right']]
lara_bymonth_elective_open = lara_bymonth_elective_open[['newdata']]

lara_bymonth_urgent_endo = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'URGENT','ENDO',75)
table_row_urgent_endo = lara_bymonth_urgent_endo[['row']]
BW_urgent_endo = lara_bymonth_urgent_endo[['bw']]
pred_left_urgent_endo = lara_bymonth_urgent_endo[['pred_left']]
pred_right_urgent_endo = lara_bymonth_urgent_endo[['pred_right']]
lara_bymonth_urgent_endo = lara_bymonth_urgent_endo[['newdata']]

lara_bymonth_elective_endo = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ELECTIVE','ENDO',75)
table_row_elective_endo = lara_bymonth_elective_endo[['row']]
BW_elective_endo = lara_bymonth_elective_endo[['bw']]
pred_left_elective_endo = lara_bymonth_elective_endo[['pred_left']]
pred_right_elective_endo = lara_bymonth_elective_endo[['pred_right']]
lara_bymonth_elective_endo = lara_bymonth_elective_endo[['newdata']]

lara_bymonth_all_endo = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ALL','ENDO',75)
table_row_all_endo = lara_bymonth_all_endo[['row']]
BW_all_endo = lara_bymonth_all_endo[['bw']]
pred_left_all_endo = lara_bymonth_all_endo[['pred_left']]
pred_right_all_endo = lara_bymonth_all_endo[['pred_right']]
lara_bymonth_all_endo = lara_bymonth_all_endo[['newdata']]

lara_bymonth_all_open = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ALL','OPEN',75)
table_row_all_open = lara_bymonth_all_open[['row']]
BW_all_open = lara_bymonth_all_open[['bw']]
pred_left_all_open = lara_bymonth_all_open[['pred_left']]
pred_right_all_open = lara_bymonth_all_open[['pred_right']]
lara_bymonth_all_open = lara_bymonth_all_open[['newdata']]

lara_bymonth_all_all = lara_bymonth %>%
  lm_quick('FREQUENCY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ALL','ALL',75)
table_row_all_all = lara_bymonth_all_all[['row']]
BW_all_all = lara_bymonth_all_all[['bw']]
pred_left_all_all = lara_bymonth_all_all[['pred_left']]
pred_right_all_all = lara_bymonth_all_all[['pred_right']]
lara_bymonth_all_all = lara_bymonth_all_all[['newdata']]
```
### URGENCY, TYPE, and RACE
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ URGENCY + TYPE
ggplot(bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo),aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and POPULATION')

# simple LOESS over the entire study period, URGENCY and TYPE combos
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and POPULATION')

# simple OLS over the entire study period, URGENCY and TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and POPULATION')

expand_grid(.variable = 'FREQUENCY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY and TYPE combos
total_preds_left = bind_rows(
  pred_left_urgent_open, pred_left_urgent_endo, pred_left_elective_open, pred_left_elective_endo
)

total_preds_right = bind_rows(
  pred_right_urgent_open, pred_right_urgent_endo, pred_right_elective_open, pred_right_elective_endo
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and POPULATION')

list(table_row_urgent_open, table_row_elective_open, table_row_urgent_endo, table_row_elective_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### URGENCY and RACE
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ URGENCY
ggplot(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency',color='URGENCY and POPULATION')

# simple LOESS over the study period, URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and POPULATION')

# simple OLS over the entire study period, URGENCY and all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and POPULATION')

expand_grid(.variable = 'FREQUENCY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY with all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME < 75 & TIME > 75 - IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME > 75 & TIME < 75 + IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME < 75 & TIME > 75 - IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME > 75 & TIME < 75 + IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and POPULATION')

list(table_row_urgent_all, table_row_elective_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# FREQUENCY by ALL, URGENT, ELECTIVE
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and POPULATION')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and POPULATION')

expand.grid(list(.variable = 'FREQUENCY',
                 .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
                 .urgency = c('ALL','URGENT','ELECTIVE'),
                 .type = c('ALL'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()
```
### TYPE and RACE
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ TYPE
ggplot(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and POPULATION')

#simple LOESS over the study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and POPULATION')

# simple OLS over the entire study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and POPULATION')

expand_grid(.variable = 'FREQUENCY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = 'ALL',
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity, TYPE with all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and POPULATION')

list(table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# FREQUENCY by ALL, ENDO, OPEN
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and POPULATION')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and POPULATION')

expand.grid(list(.variable = 'FREQUENCY',
                 .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
                 .urgency = 'ALL',
                 .type = c('ALL','OPEN','ENDO'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()

# regression discontinuity FREQUENCY ~ TYPE (including ALL)
total_preds_left = bind_rows(
  pred_left_all_all, pred_left_all_endo, pred_left_all_open
)

total_preds_right = bind_rows(
  pred_right_all_all, pred_right_all_endo, pred_right_all_open
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and POPULATION')

list(table_row_all_all, table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### RACE only
```{r, message=FALSE, echo=FALSE}
# simple LOESS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency',color='POPULATION')

# simple OLS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency',color='POPULATION')

expand_grid(.variable = 'FREQUENCY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = 'ALL',
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, group = POPULATION, color = POPULATION)) + 
  geom_ribbon(data = pred_left_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_left_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  geom_ribbon(data = pred_right_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION, color = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_right_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency',color='POPULATION')

list(table_row_all_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```

## FREQUENCY with SEX
```{r, message=FALSE, echo=FALSE}
cleanup()
lara_bymonth_urgent_all = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'URGENT','ALL',75)
table_row_urgent_all = lara_bymonth_urgent_all[['row']]
BW_urgent_all = lara_bymonth_urgent_all[['bw']]
pred_left_urgent_all = lara_bymonth_urgent_all[['pred_left']]
pred_right_urgent_all = lara_bymonth_urgent_all[['pred_right']]
lara_bymonth_urgent_all = lara_bymonth_urgent_all[['newdata']]

lara_bymonth_elective_all = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'ELECTIVE','ALL',75)
table_row_elective_all = lara_bymonth_elective_all[['row']]
BW_elective_all = lara_bymonth_elective_all[['bw']]
pred_left_elective_all = lara_bymonth_elective_all[['pred_left']]
pred_right_elective_all = lara_bymonth_elective_all[['pred_right']]
lara_bymonth_elective_all = lara_bymonth_elective_all[['newdata']]

lara_bymonth_urgent_open = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'URGENT','OPEN',75)
table_row_urgent_open = lara_bymonth_urgent_open[['row']]
BW_urgent_open = lara_bymonth_urgent_open[['bw']]
pred_left_urgent_open = lara_bymonth_urgent_open[['pred_left']]
pred_right_urgent_open = lara_bymonth_urgent_open[['pred_right']]
lara_bymonth_urgent_open = lara_bymonth_urgent_open[['newdata']]

lara_bymonth_elective_open = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'ELECTIVE','OPEN',75)
table_row_elective_open = lara_bymonth_elective_open[['row']]
BW_elective_open = lara_bymonth_elective_open[['bw']]
pred_left_elective_open = lara_bymonth_elective_open[['pred_left']]
pred_right_elective_open = lara_bymonth_elective_open[['pred_right']]
lara_bymonth_elective_open = lara_bymonth_elective_open[['newdata']]

lara_bymonth_urgent_endo = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'URGENT','ENDO',75)
table_row_urgent_endo = lara_bymonth_urgent_endo[['row']]
BW_urgent_endo = lara_bymonth_urgent_endo[['bw']]
pred_left_urgent_endo = lara_bymonth_urgent_endo[['pred_left']]
pred_right_urgent_endo = lara_bymonth_urgent_endo[['pred_right']]
lara_bymonth_urgent_endo = lara_bymonth_urgent_endo[['newdata']]

lara_bymonth_elective_endo = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'ELECTIVE','ENDO',75)
table_row_elective_endo = lara_bymonth_elective_endo[['row']]
BW_elective_endo = lara_bymonth_elective_endo[['bw']]
pred_left_elective_endo = lara_bymonth_elective_endo[['pred_left']]
pred_right_elective_endo = lara_bymonth_elective_endo[['pred_right']]
lara_bymonth_elective_endo = lara_bymonth_elective_endo[['newdata']]

lara_bymonth_all_endo = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'ALL','ENDO',75)
table_row_all_endo = lara_bymonth_all_endo[['row']]
BW_all_endo = lara_bymonth_all_endo[['bw']]
pred_left_all_endo = lara_bymonth_all_endo[['pred_left']]
pred_right_all_endo = lara_bymonth_all_endo[['pred_right']]
lara_bymonth_all_endo = lara_bymonth_all_endo[['newdata']]

lara_bymonth_all_open = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'ALL','OPEN',75)
table_row_all_open = lara_bymonth_all_open[['row']]
BW_all_open = lara_bymonth_all_open[['bw']]
pred_left_all_open = lara_bymonth_all_open[['pred_left']]
pred_right_all_open = lara_bymonth_all_open[['pred_right']]
lara_bymonth_all_open = lara_bymonth_all_open[['newdata']]

lara_bymonth_all_all = lara_bymonth %>%
  lm_quick('FREQUENCY',c('MALE','FEMALE'),'ALL','ALL',75)
table_row_all_all = lara_bymonth_all_all[['row']]
BW_all_all = lara_bymonth_all_all[['bw']]
pred_left_all_all = lara_bymonth_all_all[['pred_left']]
pred_right_all_all = lara_bymonth_all_all[['pred_right']]
lara_bymonth_all_all = lara_bymonth_all_all[['newdata']]
```
### URGENCY, TYPE, and SEX
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ URGENCY + TYPE
ggplot(bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo),aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and SEX')

# simple LOESS over the entire study period, URGENCY and TYPE combos
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and SEX')

# simple OLS over the entire study period, URGENCY and TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and SEX')

expand_grid(.variable = 'FREQUENCY',
            .population = c('MALE','FEMALE'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY and TYPE combos
total_preds_left = bind_rows(
  pred_left_urgent_open, pred_left_urgent_endo, pred_left_elective_open, pred_left_elective_endo
)

total_preds_right = bind_rows(
  pred_right_urgent_open, pred_right_urgent_endo, pred_right_elective_open, pred_right_elective_endo
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY, TYPE, and SEX')

list(table_row_urgent_open, table_row_elective_open, table_row_urgent_endo, table_row_elective_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### URGENCY and SEX
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ URGENCY
ggplot(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency',color='URGENCY and SEX')

# simple LOESS over the study period, URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and SEX')

# simple OLS over the entire study period, URGENCY and all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and SEX')

expand_grid(.variable = 'FREQUENCY',
            .population = c('MALE','FEMALE'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY with all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME < 75 & TIME > 75 - IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME > 75 & TIME < 75 + IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME < 75 & TIME > 75 - IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME > 75 & TIME < 75 + IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='URGENCY and SEX')

list(table_row_urgent_all, table_row_elective_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# FREQUENCY by ALL, URGENT, ELECTIVE
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color = 'URGENCY and SEX')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color = 'URGENCY and SEX')

expand.grid(list(.variable = 'FREQUENCY',
                 .population = c('MALE','FEMALE'),
                 .urgency = c('ALL','URGENT','ELECTIVE'),
                 .type = c('ALL'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()
```
### TYPE and SEX
```{r, message=FALSE, echo=FALSE}
# line plot of FREQUENCY ~ TYPE
ggplot(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and SEX')

#simple LOESS over the study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and SEX')

# simple OLS over the entire study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and SEX')

expand_grid(.variable = 'FREQUENCY',
            .population = c('MALE','FEMALE'),
            .urgency = 'ALL',
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to IK bandwidth about the cut point, TYPE with all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and SEX')

list(table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# FREQUENCY by ALL, ENDO, OPEN
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color = 'TYPE and SEX')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color = 'TYPE and SEX')

expand.grid(list(.variable = 'FREQUENCY',
                 .population = c('MALE','FEMALE'),
                 .urgency = 'ALL',
                 .type = c('ALL','OPEN','ENDO'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()

# regression discontinuity FREQUENCY ~ TYPE (including ALL)
total_preds_left = bind_rows(
  pred_left_all_all, pred_left_all_endo, pred_left_all_open
)

total_preds_right = bind_rows(
  pred_right_all_all, pred_right_all_endo, pred_right_all_open
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color='TYPE and SEX')

list(table_row_all_all, table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### SEX only
```{r, message=FALSE, echo=FALSE}
# simple LOESS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency', color = 'TYPE and SEX')

# simple OLS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

expand_grid(.variable = 'FREQUENCY',
            .population = c('MALE','FEMALE'),
            .urgency = 'ALL',
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, group = POPULATION, color = POPULATION)) + 
  geom_ribbon(data = pred_left_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_left_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  geom_ribbon(data = pred_right_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION, color = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_right_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Frequency')

list(table_row_all_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```

## MORTALITY with RACE
Filter by most represented racial groups:
```{r, message=FALSE, echo=FALSE}
cleanup()
lara_bymonth_urgent_all = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'URGENT','ALL',75)
table_row_urgent_all = lara_bymonth_urgent_all[['row']]
BW_urgent_all = lara_bymonth_urgent_all[['bw']]
pred_left_urgent_all = lara_bymonth_urgent_all[['pred_left']]
pred_right_urgent_all = lara_bymonth_urgent_all[['pred_right']]
lara_bymonth_urgent_all = lara_bymonth_urgent_all[['newdata']]

lara_bymonth_elective_all = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ELECTIVE','ALL',75)
table_row_elective_all = lara_bymonth_elective_all[['row']]
BW_elective_all = lara_bymonth_elective_all[['bw']]
pred_left_elective_all = lara_bymonth_elective_all[['pred_left']]
pred_right_elective_all = lara_bymonth_elective_all[['pred_right']]
lara_bymonth_elective_all = lara_bymonth_elective_all[['newdata']]

lara_bymonth_urgent_open = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'URGENT','OPEN',75)
table_row_urgent_open = lara_bymonth_urgent_open[['row']]
BW_urgent_open = lara_bymonth_urgent_open[['bw']]
pred_left_urgent_open = lara_bymonth_urgent_open[['pred_left']]
pred_right_urgent_open = lara_bymonth_urgent_open[['pred_right']]
lara_bymonth_urgent_open = lara_bymonth_urgent_open[['newdata']]

lara_bymonth_elective_open = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ELECTIVE','OPEN',75)
table_row_elective_open = lara_bymonth_elective_open[['row']]
BW_elective_open = lara_bymonth_elective_open[['bw']]
pred_left_elective_open = lara_bymonth_elective_open[['pred_left']]
pred_right_elective_open = lara_bymonth_elective_open[['pred_right']]
lara_bymonth_elective_open = lara_bymonth_elective_open[['newdata']]

lara_bymonth_urgent_endo = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'URGENT','ENDO',75)
table_row_urgent_endo = lara_bymonth_urgent_endo[['row']]
BW_urgent_endo = lara_bymonth_urgent_endo[['bw']]
pred_left_urgent_endo = lara_bymonth_urgent_endo[['pred_left']]
pred_right_urgent_endo = lara_bymonth_urgent_endo[['pred_right']]
lara_bymonth_urgent_endo = lara_bymonth_urgent_endo[['newdata']]

lara_bymonth_elective_endo = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','ASIAN','"PARDA"'),'ELECTIVE','ENDO',75) #'BLACK' removed due to error in rdrobust() line 326
table_row_elective_endo = lara_bymonth_elective_endo[['row']]
BW_elective_endo = lara_bymonth_elective_endo[['bw']]
pred_left_elective_endo = lara_bymonth_elective_endo[['pred_left']]
pred_right_elective_endo = lara_bymonth_elective_endo[['pred_right']]
lara_bymonth_elective_endo = lara_bymonth_elective_endo[['newdata']]

lara_bymonth_all_endo = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ALL','ENDO',75)
table_row_all_endo = lara_bymonth_all_endo[['row']]
BW_all_endo = lara_bymonth_all_endo[['bw']]
pred_left_all_endo = lara_bymonth_all_endo[['pred_left']]
pred_right_all_endo = lara_bymonth_all_endo[['pred_right']]
lara_bymonth_all_endo = lara_bymonth_all_endo[['newdata']]

lara_bymonth_all_open = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ALL','OPEN',75)
table_row_all_open = lara_bymonth_all_open[['row']]
BW_all_open = lara_bymonth_all_open[['bw']]
pred_left_all_open = lara_bymonth_all_open[['pred_left']]
pred_right_all_open = lara_bymonth_all_open[['pred_right']]
lara_bymonth_all_open = lara_bymonth_all_open[['newdata']]

lara_bymonth_all_all = lara_bymonth %>%
  lm_quick('MORTALITY',c('WHITE','BLACK','ASIAN','"PARDA"'),'ALL','ALL',75)
table_row_all_all = lara_bymonth_all_all[['row']]
BW_all_all = lara_bymonth_all_all[['bw']]
pred_left_all_all = lara_bymonth_all_all[['pred_left']]
pred_right_all_all = lara_bymonth_all_all[['pred_right']]
lara_bymonth_all_all = lara_bymonth_all_all[['newdata']]
```
### URGENCY, TYPE, and RACE
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ URGENCY + TYPE
ggplot(bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo),aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY, TYPE, and POPULATION')

# simple LOESS over the entire study period, URGENCY and TYPE combos
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY, TYPE, and POPULATION')

# simple OLS over the entire study period, URGENCY and TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY, TYPE, and POPULATION')

expand_grid(.variable = 'MORTALITY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY and TYPE combos
total_preds_left = bind_rows(
  pred_left_urgent_open, pred_left_urgent_endo, pred_left_elective_open, pred_left_elective_endo
)

total_preds_right = bind_rows(
  pred_right_urgent_open, pred_right_urgent_endo, pred_right_elective_open, pred_right_elective_endo
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY, TYPE, and POPULATION')

list(table_row_urgent_open, table_row_elective_open, table_row_urgent_endo, table_row_elective_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### URGENCY and RACE
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ URGENCY
ggplot(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality',color='URGENCY and POPULATION')

# simple LOESS over the study period, URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and POPULATION')

# simple OLS over the entire study period, URGENCY and all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and POPULATION')

expand_grid(.variable = 'MORTALITY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY with all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME < 75 & TIME > 75 - IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME > 75 & TIME < 75 + IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME < 75 & TIME > 75 - IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME > 75 & TIME < 75 + IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and POPULATION')

list(table_row_urgent_all, table_row_elective_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# MORTALITY by ALL, URGENT, ELECTIVE
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and POPULATION')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and POPULATION')

expand.grid(list(.variable = 'MORTALITY',
                 .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
                 .urgency = c('ALL','URGENT','ELECTIVE'),
                 .type = c('ALL'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()
```
### TYPE and RACE
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ TYPE
ggplot(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE and POPULATION')

#simple LOESS over the study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE and POPULATION')

# simple OLS over the entire study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE and POPULATION')

expand_grid(.variable = 'MORTALITY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = 'ALL',
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to IK bandwidth about the cut point, TYPE with all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE and POPULATION')

list(table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# MORTALITY by ALL, ENDO, OPEN
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE and POPULATION')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE and POPULATION')

expand.grid(list(.variable = 'MORTALITY',
                 .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
                 .urgency = 'ALL',
                 .type = c('ALL','OPEN','ENDO'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()

# regression discontinuity MORTALITY ~ TYPE (including ALL)
total_preds_left = bind_rows(
  pred_left_all_all, pred_left_all_endo, pred_left_all_open
)

total_preds_right = bind_rows(
  pred_right_all_all, pred_right_all_endo, pred_right_all_open
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE and POPULATION')

list(table_row_all_all, table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### RACE only
```{r, message=FALSE, echo=FALSE}
# simple LOESS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality',color='POPULATION')

# simple OLS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality',color='POPULATION')

expand_grid(.variable = 'MORTALITY',
            .population = c('WHITE','BLACK','ASIAN','"PARDA"'),
            .urgency = 'ALL',
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, group = POPULATION, color = POPULATION)) + 
  geom_ribbon(data = pred_left_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_left_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  geom_ribbon(data = pred_right_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION, color = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_right_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality',color='POPULATION')

list(table_row_all_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```

## MORTALITY with SEX
```{r, message=FALSE, echo=FALSE}
cleanup()
lara_bymonth_urgent_all = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'URGENT','ALL',75)
table_row_urgent_all = lara_bymonth_urgent_all[['row']]
BW_urgent_all = lara_bymonth_urgent_all[['bw']]
pred_left_urgent_all = lara_bymonth_urgent_all[['pred_left']]
pred_right_urgent_all = lara_bymonth_urgent_all[['pred_right']]
lara_bymonth_urgent_all = lara_bymonth_urgent_all[['newdata']]

lara_bymonth_elective_all = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'ELECTIVE','ALL',75)
table_row_elective_all = lara_bymonth_elective_all[['row']]
BW_elective_all = lara_bymonth_elective_all[['bw']]
pred_left_elective_all = lara_bymonth_elective_all[['pred_left']]
pred_right_elective_all = lara_bymonth_elective_all[['pred_right']]
lara_bymonth_elective_all = lara_bymonth_elective_all[['newdata']]

lara_bymonth_urgent_open = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'URGENT','OPEN',75)
table_row_urgent_open = lara_bymonth_urgent_open[['row']]
BW_urgent_open = lara_bymonth_urgent_open[['bw']]
pred_left_urgent_open = lara_bymonth_urgent_open[['pred_left']]
pred_right_urgent_open = lara_bymonth_urgent_open[['pred_right']]
lara_bymonth_urgent_open = lara_bymonth_urgent_open[['newdata']]

lara_bymonth_elective_open = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'ELECTIVE','OPEN',75)
table_row_elective_open = lara_bymonth_elective_open[['row']]
BW_elective_open = lara_bymonth_elective_open[['bw']]
pred_left_elective_open = lara_bymonth_elective_open[['pred_left']]
pred_right_elective_open = lara_bymonth_elective_open[['pred_right']]
lara_bymonth_elective_open = lara_bymonth_elective_open[['newdata']]

lara_bymonth_urgent_endo = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'URGENT','ENDO',75)
table_row_urgent_endo = lara_bymonth_urgent_endo[['row']]
BW_urgent_endo = lara_bymonth_urgent_endo[['bw']]
pred_left_urgent_endo = lara_bymonth_urgent_endo[['pred_left']]
pred_right_urgent_endo = lara_bymonth_urgent_endo[['pred_right']]
lara_bymonth_urgent_endo = lara_bymonth_urgent_endo[['newdata']]

lara_bymonth_elective_endo = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'ELECTIVE','ENDO',75)
table_row_elective_endo = lara_bymonth_elective_endo[['row']]
BW_elective_endo = lara_bymonth_elective_endo[['bw']]
pred_left_elective_endo = lara_bymonth_elective_endo[['pred_left']]
pred_right_elective_endo = lara_bymonth_elective_endo[['pred_right']]
lara_bymonth_elective_endo = lara_bymonth_elective_endo[['newdata']]

lara_bymonth_all_endo = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'ALL','ENDO',75)
table_row_all_endo = lara_bymonth_all_endo[['row']]
BW_all_endo = lara_bymonth_all_endo[['bw']]
pred_left_all_endo = lara_bymonth_all_endo[['pred_left']]
pred_right_all_endo = lara_bymonth_all_endo[['pred_right']]
lara_bymonth_all_endo = lara_bymonth_all_endo[['newdata']]

lara_bymonth_all_open = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'ALL','OPEN',75)
table_row_all_open = lara_bymonth_all_open[['row']]
BW_all_open = lara_bymonth_all_open[['bw']]
pred_left_all_open = lara_bymonth_all_open[['pred_left']]
pred_right_all_open = lara_bymonth_all_open[['pred_right']]
lara_bymonth_all_open = lara_bymonth_all_open[['newdata']]

lara_bymonth_all_all = lara_bymonth %>%
  lm_quick('MORTALITY',c('MALE','FEMALE'),'ALL','ALL',75)
table_row_all_all = lara_bymonth_all_all[['row']]
BW_all_all = lara_bymonth_all_all[['bw']]
pred_left_all_all = lara_bymonth_all_all[['pred_left']]
pred_right_all_all = lara_bymonth_all_all[['pred_right']]
lara_bymonth_all_all = lara_bymonth_all_all[['newdata']]
```
### URGENCY, TYPE, and SEX
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ URGENCY + TYPE
ggplot(bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo),aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

# simple LOESS over the entire study period, URGENCY and TYPE combos
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

# simple OLS over the entire study period, URGENCY and TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

expand_grid(.variable = 'MORTALITY',
            .population = c('MALE','FEMALE'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY and TYPE combos
total_preds_left = bind_rows(
  pred_left_urgent_open, pred_left_urgent_endo, pred_left_elective_open, pred_left_elective_endo
)

total_preds_right = bind_rows(
  pred_right_urgent_open, pred_right_urgent_endo, pred_right_elective_open, pred_right_elective_endo
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY and TYPE')

list(table_row_urgent_open, table_row_elective_open, table_row_urgent_endo, table_row_elective_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### URGENCY and SEX
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ URGENCY
ggplot(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality',color='URGENCY')

# simple LOESS over the study period, URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY')

# simple OLS over the entire study period, URGENCY and all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY')

expand_grid(.variable = 'MORTALITY',
            .population = c('MALE','FEMALE'),
            .urgency = c('URGENT','ELECTIVE'),
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY with all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME < 75 & TIME > 75 - IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_urgent_all, TIME > 75 & TIME < 75 + IKB_urgent_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME < 75 & TIME > 75 - IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_elective_all, TIME > 75 & TIME < 75 + IKB_elective_all), aes(x=TIME, y=VALUE, color=URGENCY), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='URGENCY')

list(table_row_urgent_all, table_row_elective_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# MORTALITY by ALL, URGENT, ELECTIVE
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,POPULATION), group = interaction(URGENCY,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

expand.grid(list(.variable = 'MORTALITY',
                 .population = c('MALE','FEMALE'),
                 .urgency = c('ALL','URGENT','ELECTIVE'),
                 .type = c('ALL'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()
```
### TYPE and SEX
```{r, message=FALSE, echo=FALSE}
# line plot of MORTALITY ~ TYPE
ggplot(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

#simple LOESS over the study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

# simple OLS over the entire study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(TYPE,POPULATION))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

expand_grid(.variable = 'MORTALITY',
            .population = c('MALE','FEMALE'),
            .urgency = 'ALL',
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to IK bandwidth about the cut point, TYPE with all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

list(table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# MORTALITY by ALL, ENDO, OPEN
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

expand.grid(list(.variable = 'MORTALITY',
                 .population = c('MALE','FEMALE'),
                 .urgency = 'ALL',
                 .type = c('ALL','OPEN','ENDO'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()

# regression discontinuity MORTALITY ~ TYPE (including ALL)
total_preds_left = bind_rows(
  pred_left_all_all, pred_left_all_endo, pred_left_all_open
)

total_preds_right = bind_rows(
  pred_right_all_all, pred_right_all_endo, pred_right_all_open
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(TYPE,POPULATION)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(TYPE,POPULATION), group = interaction(TYPE,POPULATION)), linewidth = 1.25) +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME < 75 & TIME > 75 - IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_open, TIME > 75 & TIME < 75 + IKB_all_open), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME < 75 & TIME > 75 - IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  # geom_smooth(data = subset(lara_bymonth_all_endo, TIME > 75 & TIME < 75 + IKB_all_endo), aes(x=TIME, y=VALUE, color=TYPE), formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality', color='TYPE')

list(table_row_all_all, table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### SEX only
```{r, message=FALSE, echo=FALSE}
# simple LOESS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

# simple OLS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION), group = interaction(URGENCY,TYPE,POPULATION)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, color = POPULATION)) + #, colour = interaction(URGENCY,TYPE,POPULATION)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

expand_grid(.variable = 'MORTALITY',
            .population = c('MALE','FEMALE'),
            .urgency = 'ALL',
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, group = POPULATION, color = POPULATION)) + 
  geom_ribbon(data = pred_left_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_left_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  geom_ribbon(data = pred_right_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = POPULATION, color = POPULATION), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_right_all_all, aes(x = PERIOD, y = VALUE, group = POPULATION, color = POPULATION), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Mortality')

list(table_row_all_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```

## AVERAGE LOS
```{r, echo=FALSE, warning=FALSE}
cleanup()
lara_bymonth_urgent_all = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','URGENT','ALL',75)
table_row_urgent_all = lara_bymonth_urgent_all[['row']]
BW_urgent_all = lara_bymonth_urgent_all[['bw']]
pred_left_urgent_all = lara_bymonth_urgent_all[['pred_left']]
pred_right_urgent_all = lara_bymonth_urgent_all[['pred_right']]
lara_bymonth_urgent_all = lara_bymonth_urgent_all[['newdata']]

lara_bymonth_elective_all = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','ELECTIVE','ALL',75)
table_row_elective_all = lara_bymonth_elective_all[['row']]
BW_elective_all = lara_bymonth_elective_all[['bw']]
pred_left_elective_all = lara_bymonth_elective_all[['pred_left']]
pred_right_elective_all = lara_bymonth_elective_all[['pred_right']]
lara_bymonth_elective_all = lara_bymonth_elective_all[['newdata']]

lara_bymonth_urgent_open = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','URGENT','OPEN',75)
table_row_urgent_open = lara_bymonth_urgent_open[['row']]
BW_urgent_open = lara_bymonth_urgent_open[['bw']]
pred_left_urgent_open = lara_bymonth_urgent_open[['pred_left']]
pred_right_urgent_open = lara_bymonth_urgent_open[['pred_right']]
lara_bymonth_urgent_open = lara_bymonth_urgent_open[['newdata']]

lara_bymonth_elective_open = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','ELECTIVE','OPEN',75)
table_row_elective_open = lara_bymonth_elective_open[['row']]
BW_elective_open = lara_bymonth_elective_open[['bw']]
pred_left_elective_open = lara_bymonth_elective_open[['pred_left']]
pred_right_elective_open = lara_bymonth_elective_open[['pred_right']]
lara_bymonth_elective_open = lara_bymonth_elective_open[['newdata']]

lara_bymonth_urgent_endo = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','URGENT','ENDO',75)
table_row_urgent_endo = lara_bymonth_urgent_endo[['row']]
BW_urgent_endo = lara_bymonth_urgent_endo[['bw']]
pred_left_urgent_endo = lara_bymonth_urgent_endo[['pred_left']]
pred_right_urgent_endo = lara_bymonth_urgent_endo[['pred_right']]
lara_bymonth_urgent_endo = lara_bymonth_urgent_endo[['newdata']]

lara_bymonth_elective_endo = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','ELECTIVE','ENDO',75)
table_row_elective_endo = lara_bymonth_elective_endo[['row']]
BW_elective_endo = lara_bymonth_elective_endo[['bw']]
pred_left_elective_endo = lara_bymonth_elective_endo[['pred_left']]
pred_right_elective_endo = lara_bymonth_elective_endo[['pred_right']]
lara_bymonth_elective_endo = lara_bymonth_elective_endo[['newdata']]

lara_bymonth_all_endo = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','ALL','ENDO',75)
table_row_all_endo = lara_bymonth_all_endo[['row']]
BW_all_endo = lara_bymonth_all_endo[['bw']]
pred_left_all_endo = lara_bymonth_all_endo[['pred_left']]
pred_right_all_endo = lara_bymonth_all_endo[['pred_right']]
lara_bymonth_all_endo = lara_bymonth_all_endo[['newdata']]

lara_bymonth_all_open = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','ALL','OPEN',75)
table_row_all_open = lara_bymonth_all_open[['row']]
BW_all_open = lara_bymonth_all_open[['bw']]
pred_left_all_open = lara_bymonth_all_open[['pred_left']]
pred_right_all_open = lara_bymonth_all_open[['pred_right']]
lara_bymonth_all_open = lara_bymonth_all_open[['newdata']]

lara_bymonth_all_all = lara_bymonth %>%
  lm_quick('AVERAGE LOS','GLOBAL','ALL','ALL',75)
table_row_all_all = lara_bymonth_all_all[['row']]
BW_all_all = lara_bymonth_all_all[['bw']]
pred_left_all_all = lara_bymonth_all_all[['pred_left']]
pred_right_all_all = lara_bymonth_all_all[['pred_right']]
lara_bymonth_all_all = lara_bymonth_all_all[['newdata']]
```
### URGENCY and TYPE
```{r, message=FALSE, echo=FALSE}
# line plot of AVERAGE LOS ~ URGENCY + TYPE
ggplot(bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo),aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='URGENCY and TYPE')

# simple LOESS over the entire study period, URGENCY and TYPE combos
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='URGENCY and TYPE')

# simple OLS over the entire study period, URGENCY and TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = interaction(URGENCY,TYPE))) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='URGENCY and TYPE')

expand_grid(.variable = 'AVERAGE LOS',
            .population = 'GLOBAL',
            .urgency = c('URGENT','ELECTIVE'),
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY and TYPE combos
total_preds_left = bind_rows(
  pred_left_urgent_open, pred_left_urgent_endo, pred_left_elective_open, pred_left_elective_endo
)

total_preds_right = bind_rows(
  pred_right_urgent_open, pred_right_urgent_endo, pred_right_elective_open, pred_right_elective_endo
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_open, lara_bymonth_elective_open, lara_bymonth_urgent_endo, lara_bymonth_elective_endo), aes(x=PERIOD, y=VALUE, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE))) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='URGENCY and TYPE')

list(table_row_urgent_open, table_row_elective_open, table_row_urgent_endo, table_row_elective_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### URGENCY only
```{r, message=FALSE, echo=FALSE}
# line plot of AVERAGE LOS ~ URGENCY
ggplot(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS',color='URGENCY')

# simple LOESS over the study period, URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = URGENCY)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='URGENCY')

# simple OLS over the entire study period, URGENCY and all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_smooth(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = URGENCY)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='URGENCY')

expand_grid(.variable = 'AVERAGE LOS',
            .population = 'GLOBAL',
            .urgency = c('URGENT','ELECTIVE'),
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, URGENCY with all TYPE
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_ribbon(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = URGENCY), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_urgent_all, pred_left_elective_all), aes(x = PERIOD, y = VALUE, color = URGENCY, group = URGENCY), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = URGENCY), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_urgent_all, pred_right_elective_all), aes(x = PERIOD, y = VALUE, color = URGENCY, group = URGENCY), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='URGENCY')

list(table_row_urgent_all, table_row_elective_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# AVERAGE LOS by ALL, URGENT, ELECTIVE
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_urgent_all, lara_bymonth_elective_all), aes(x=PERIOD, y=VALUE, colour = URGENCY, group = URGENCY)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS')

expand.grid(list(.variable = 'AVERAGE LOS',
                 .population = 'GLOBAL',
                 .urgency = c('ALL','URGENT','ELECTIVE'),
                 .type = c('ALL'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()
```
### TYPE only
```{r, message=FALSE, echo=FALSE}
# line plot of AVERAGE LOS ~ TYPE
ggplot(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='TYPE')

#simple LOESS over the study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE, colour = TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='TYPE')

# simple OLS over the entire study period, TYPE and all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_smooth(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE, colour = TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='TYPE')

expand_grid(.variable = 'AVERAGE LOS',
            .population = 'GLOBAL',
            .urgency = 'ALL',
            .type = c('OPEN','ENDO'),
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to IK bandwidth about the cut point, TYPE with all URGENCY
ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_ribbon(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_left_all_open, pred_left_all_endo), aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  geom_ribbon(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = bind_rows(pred_right_all_open, pred_right_all_endo), aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='TYPE')

list(table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# AVERAGE LOS by ALL, ENDO, OPEN
ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_point() +
  geom_smooth(formula = y~x, method = 'loess') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS')

ggplot(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_endo, lara_bymonth_all_open), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = 'lm') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS')

expand.grid(list(.variable = 'AVERAGE LOS',
                 .population = 'GLOBAL',
                 .urgency = 'ALL',
                 .type = c('ALL','OPEN','ENDO'),
                 .predict = NA)) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>% 
  kbl() %>% 
  kable_classic()

# regression discontinuity AVERAGE LOS ~ TYPE (including ALL)
total_preds_left = bind_rows(
  pred_left_all_all, pred_left_all_endo, pred_left_all_open
)

total_preds_right = bind_rows(
  pred_right_all_all, pred_right_all_endo, pred_right_all_open
)

ggplot() +
  geom_point(data = bind_rows(lara_bymonth_all_all, lara_bymonth_all_open, lara_bymonth_all_endo), aes(x=PERIOD, y=VALUE, colour = TYPE, group = TYPE)) +
  geom_ribbon(data = total_preds_left, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_left, aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  geom_ribbon(data = total_preds_right, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = TYPE), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = total_preds_right, aes(x = PERIOD, y = VALUE, color = TYPE, group = TYPE), linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS', color='TYPE')

list(table_row_all_all, table_row_all_open, table_row_all_endo) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```
### Entire Population
```{r, message=FALSE, echo=FALSE}
# simple LOESS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE)) + #, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'loess', aes(x=TIME, y=VALUE)) + #, colour = interaction(URGENCY,TYPE)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS')

# simple OLS over the entire study period, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE)) + #, colour = interaction(URGENCY,TYPE), group = interaction(URGENCY,TYPE)
  geom_smooth(data = lara_bymonth_all_all, formula = y ~ x, method = 'lm', aes(x=TIME, y=VALUE)) + #, colour = interaction(URGENCY,TYPE)
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS')

expand_grid(.variable = 'AVERAGE LOS',
            .population = 'GLOBAL',
            .urgency = 'ALL',
            .type = 'ALL',
            .predict = NA) %>% 
  pmap(lm_quick, .data=lara_bymonth) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()

# regression discontinuity limited to bandwidth about the cut point, all URGENCY and all TYPE (one line)
ggplot() +
  geom_point(data = lara_bymonth_all_all, aes(x=PERIOD, y=VALUE, group = interaction(URGENCY,TYPE))) + 
  geom_ribbon(data = pred_left_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_left_all_all, aes(x = PERIOD, y = VALUE, group = interaction(URGENCY,TYPE)), linewidth = 1.25, color = 'blue') +
  geom_ribbon(data = pred_right_all_all, aes(x = PERIOD, ymin = LOWER, ymax = UPPER, group = interaction(URGENCY,TYPE)), alpha = 0.2, color = 'gray', linetype = 0) +
  geom_line(data = pred_right_all_all, aes(x = PERIOD, y = VALUE, group = interaction(URGENCY,TYPE)), color = 'blue', linewidth = 1.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(x='Month',y='Average LOS')

list(table_row_all_all) %>% 
  bind_rows() %>%
  kbl() %>% 
  kable_classic()
```

## Figure 4. Mortality by Population Subgroup, 2014-2023
```{r, message=FALSE, echo=FALSE}
lara_bymonth %>% 
  filter(VARIABLE %in% c('FREQUENCY','DEATHS')) %>% 
  filter(POPULATION %in% c('GLOBAL','WHITE','BLACK','"PARDA"')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(POPULATION, URGENCY, TYPE, VARIABLE) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  pivot_wider(names_from = VARIABLE, values_from = TOTAL) %>% 
  mutate(MORTALITY = DEATHS/FREQUENCY) %>% 
  ggplot() +
  geom_col(aes(fill = POPULATION, x=POPULATION, y=MORTALITY)) +
  facet_grid(vars(URGENCY), vars(TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Mortality')

lara_bymonth %>% 
  filter(VARIABLE %in% c('FREQUENCY','DEATHS')) %>% 
  filter(POPULATION %in% c('GLOBAL','MALE','FEMALE')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(POPULATION, URGENCY, TYPE, VARIABLE) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  pivot_wider(names_from = VARIABLE, values_from = TOTAL) %>% 
  mutate(MORTALITY = DEATHS/FREQUENCY) %>% 
  ggplot() +
  geom_col(aes(fill = POPULATION, x=POPULATION, y=MORTALITY)) +
  facet_grid(vars(URGENCY), vars(TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Mortality')
```

## Figure 5. Endo versus Open Repair by Population Subgroup, 2014-2023
```{r, message=FALSE, echo=FALSE}
lara_bymonth %>% 
  filter(VARIABLE == 'FREQUENCY') %>% 
  filter(URGENCY != 'ALL') %>% 
  filter(TYPE != 'ALL') %>% 
  filter(POPULATION %in% c('GLOBAL','WHITE','BLACK','"PARDA"','ASIAN','MALE','FEMALE')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(POPULATION, TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  ggplot(aes(fill = TYPE, x=POPULATION, y=TOTAL)) +
  geom_bar(position = 'fill', stat='identity') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Proportion')

lara_bymonth %>% 
  filter(VARIABLE == 'FREQUENCY') %>% 
  filter(URGENCY != 'ALL') %>% 
  filter(TYPE != 'ALL') %>% 
  filter(POPULATION %in% c('WHITE','BLACK','"PARDA"','ASIAN')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(URGENCY, TYPE, POPULATION) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  ggplot(aes(fill = POPULATION, x=URGENCY, y=TOTAL)) +
  geom_bar(position = 'fill', stat='identity') +
  facet_grid(.~TYPE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Proportion')

lara_bymonth %>% 
  filter(VARIABLE == 'FREQUENCY') %>% 
  filter(URGENCY != 'ALL') %>% 
  filter(TYPE != 'ALL') %>% 
  filter(POPULATION %in% c('GLOBAL','WHITE','BLACK','"PARDA"','ASIAN','MALE','FEMALE')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(POPULATION, URGENCY, TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  ggplot(aes(fill = TYPE, x=URGENCY, y=TOTAL, group = POPULATION)) +
  geom_bar(position = 'fill', stat='identity') +
  facet_grid(.~POPULATION)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Proportion')

lara_bymonth %>% 
  filter(VARIABLE == 'FREQUENCY') %>% 
  filter(URGENCY != 'ALL') %>% 
  filter(TYPE != 'ALL') %>% 
  filter(POPULATION %in% c('GLOBAL','WHITE','BLACK','"PARDA"','ASIAN','MALE','FEMALE')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(POPULATION, URGENCY, TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  ggplot(aes(fill = TYPE, x=POPULATION, y=TOTAL, group = POPULATION)) +
  geom_bar(position = 'fill', stat='identity') +
  facet_grid(.~URGENCY)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Proportion')

lara_bymonth %>% 
  filter(VARIABLE == 'FREQUENCY') %>% 
  filter(POPULATION %in% c('WHITE','BLACK','"PARDA"','ASIAN')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(URGENCY, TYPE, POPULATION) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  ggplot(aes(fill = POPULATION, x=POPULATION, y=TOTAL)) +
  geom_bar(stat='identity') +
  facet_grid(vars(URGENCY), vars(TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Frequency')

lara_bymonth %>% 
  filter(VARIABLE == 'FREQUENCY') %>% 
  filter(POPULATION %in% c('MALE','FEMALE')) %>% 
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(URGENCY, TYPE, POPULATION) %>% 
  summarise(TOTAL = sum(VALUE)) %>%
  ggplot(aes(fill = POPULATION, x=POPULATION, y=TOTAL)) +
  geom_bar(stat='identity') +
  facet_grid(vars(URGENCY), vars(TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='Group',y='Frequency')
```

## Figure 6. Mortality Before and After COVID
```{r, echo=FALSE}
year_month_titles <- lara_bymonth %>% pull(PERIOD) %>% unique()

lara_bymonth %>%
  filter(VARIABLE %in% c('DEATHS','FREQUENCY')) %>%
  filter(!is.na(PERIOD)) %>%
  filter(POPULATION == 'GLOBAL') %>%
  mutate(COVID = c('BEFORE','AFTER')[(as.integer(PERIOD) >= as.integer(year_month_titles[75]))+1]) %>% #[75] == 'Mar_2020'
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(URGENCY, TYPE, COVID, VARIABLE) %>%
  summarise(TOTAL = sum(VALUE)) %>%
  pivot_wider(names_from = VARIABLE, values_from = TOTAL) %>% 
  mutate(MORTALITY = DEATHS/FREQUENCY) %>%  
  ggplot(aes(x=COVID, y=MORTALITY, fill = COVID)) +
  geom_col() +
  facet_grid(vars(URGENCY),vars(TYPE)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = unique(lara_bymonth$PERIOD)[seq(1, 123, by = 6)]) +
  geom_vline(xintercept = "2020_Mar", linetype = "dashed", color = "black", size = 1) +
  geom_vline(xintercept = "2023_Abr", linetype = "dashed", color = "black", size = 1) +
  labs(y='Mortality')
```
## Extra Figures per Request
```{r, echo=FALSE}
year_month_titles <- lara_bymonth %>% pull(PERIOD) %>% unique()

lara_bymonth %>%
  filter(VARIABLE == 'FREQUENCY') %>%
  filter(!is.na(PERIOD)) %>%
  filter(POPULATION == 'GLOBAL') %>%
  filter(URGENCY != 'ALL') %>% 
  mutate(COVID = factor(c('BEFORE','AFTER'), levels = c('BEFORE','AFTER'))[(as.integer(PERIOD) >= as.integer(year_month_titles[75]))+1]) %>% #[75] == 'Mar_2020'
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(URGENCY, TYPE, COVID, VARIABLE) %>%
  summarise(TOTAL = sum(VALUE)) %>% 
  ggplot(aes(x=COVID, y=TOTAL, fill = URGENCY)) +
  geom_bar(position = 'fill', stat = 'identity') +
  facet_grid(.~TYPE)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y='Mortality')

lara_bymonth %>%
  filter(VARIABLE == 'FREQUENCY') %>%
  filter(!is.na(PERIOD)) %>%
  filter(POPULATION == 'GLOBAL') %>%
  filter(TYPE != 'ALL') %>% 
  mutate(COVID = factor(c('BEFORE','AFTER'), levels = c('BEFORE','AFTER'))[(as.integer(PERIOD) >= as.integer(year_month_titles[75]))+1]) %>% #[75] == 'Mar_2020'
  mutate(VALUE = if_else(is.na(VALUE), 0, VALUE)) %>% 
  group_by(URGENCY, TYPE, COVID, VARIABLE) %>%
  summarise(TOTAL = sum(VALUE)) %>% 
  ggplot(aes(x=COVID, y=TOTAL, fill = TYPE)) +
  geom_bar(position = 'fill', stat = 'identity') +
  facet_grid(.~URGENCY)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y='Mortality')

lara_bymonth %>% 
  quick_filter('DEATHS','GLOBAL',c('ELECTIVE','URGENT'),c('ENDO','OPEN')) %>%
  group_by(URGENCY,TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = '', y = TOTAL, fill = interaction(URGENCY, TYPE)))+
  geom_bar(stat='identity', color = 'black') +
  coord_polar(theta = 'y') +
  geom_text(aes(label = TOTAL),
            position = position_stack(vjust = 0.5)) +
  labs(x = '', y = 'Total Deaths (2014-2023)', fill='URGENCY and TYPE') +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        #axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#ffffff")) 

lara_bymonth %>% 
  quick_filter('DEATHS','GLOBAL','ALL',c('ENDO','OPEN')) %>%
  group_by(TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = '', y = TOTAL, fill = TYPE))+
  geom_bar(stat='identity', color = 'black') +
  coord_polar(theta = 'y') +
  geom_text(aes(label = TOTAL),
            position = position_stack(vjust = 0.5)) +
  labs(x = '', y = 'Total Deaths (2014-2023)', fill='TYPE') +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        #axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#ffffff")) 

lara_bymonth %>% 
  quick_filter('DEATHS','GLOBAL',c('ELECTIVE','URGENT'),'ALL') %>%
  group_by(URGENCY,TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = '', y = TOTAL, fill = URGENCY))+
  geom_bar(stat='identity', color = 'black') +
  coord_polar(theta = 'y') +
  geom_text(aes(label = TOTAL),
            position = position_stack(vjust = 0.5)) +
  labs(x = '', y = 'Total Deaths (2014-2023)', fill='URGENCY') +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        #axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#ffffff")) 

lara_bymonth %>% 
  quick_filter(c('FREQUENCY','DEATHS'),c('MALE','FEMALE'),'ALL','ALL') %>%
  group_by(VARIABLE, POPULATION) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = '', y = TOTAL, fill = POPULATION))+
  geom_bar(position = 'fill', stat='identity', color = 'black') +
  # coord_polar(theta = 'y') +
  geom_text(aes(label = TOTAL),
            position = position_fill(vjust = 0.5)) +
  labs(x = '', fill='POPULATION') +
  facet_grid(.~VARIABLE) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        #axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#ffffff"))

lara_bymonth %>% 
  quick_filter(c('FREQUENCY','DEATHS'),c('MALE','FEMALE'),'ALL','ALL') %>%
  group_by(VARIABLE, POPULATION) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  ungroup() %>% 
  ggplot(aes(x = '', y = TOTAL, fill = POPULATION))+
  geom_bar(position = 'fill', stat='identity', color = 'black') +
  coord_polar(theta = 'y') +
  geom_text(aes(label = TOTAL),
            position = position_fill(vjust = 0.5)) +
  labs(x = '', fill='POPULATION') +
  facet_grid(.~VARIABLE) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        #axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#ffffff"))

lara_bymonth %>% 
  quick_filter(c('FREQUENCY', 'DEATHS'),c('MALE','FEMALE'),'ALL','ALL') %>%
  group_by(VARIABLE, POPULATION) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  spread(key = VARIABLE, value = TOTAL) %>%
  mutate(ALIVE = FREQUENCY - DEATHS) %>% 
  select(POPULATION, DEATHS, ALIVE) %>%
  pivot_longer(cols=c('DEATHS','ALIVE'), names_to = 'VARIABLE', values_to = 'TOTAL') %>% 
  ungroup() %>%
  ggplot(aes(x = '', y = TOTAL, fill = VARIABLE))+
  geom_bar(position = 'fill', stat='identity', color = 'black') +
  coord_polar(theta = 'y') +
  geom_text(aes(label = TOTAL),
            position = position_fill(vjust = 0.5)) +
  labs(x = '', fill='POPULATION') +
  facet_grid(.~POPULATION) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        #axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#ffffff"))

```
Check for differences in 10yr mortality rates by sex among elective endo cases:
```{r}
df_sex <- lara_bymonth %>% 
  quick_filter(c('DEATHS','FREQUENCY'), c('MALE','FEMALE'),'ELECTIVE',c('OPEN','ENDO')) %>% 
  group_by(VARIABLE, POPULATION, URGENCY, TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  ungroup()

endo_data <- df_sex %>%
  filter(TYPE == 'ENDO', URGENCY == 'ELECTIVE') %>%
  spread(key = VARIABLE, value = TOTAL) %>%
  mutate(ALIVE = FREQUENCY - DEATHS) %>%
  select(POPULATION, DEATHS, ALIVE) %>%
  column_to_rownames(var = "POPULATION") %>%
  as.matrix()

open_data <- df_sex %>%
  filter(TYPE == 'OPEN', URGENCY == 'ELECTIVE') %>%
  spread(key = VARIABLE, value = TOTAL) %>%
  mutate(Survivals = FREQUENCY - DEATHS) %>%
  select(POPULATION, DEATHS, Survivals) %>%
  column_to_rownames(var = "POPULATION") %>%
  as.matrix()

all_data <- df_sex %>%
  filter(URGENCY == 'ELECTIVE') %>%
  group_by(POPULATION) %>%
  summarize(DEATHS = sum(TOTAL[VARIABLE == 'DEATHS']),
            FREQUENCY = sum(TOTAL[VARIABLE == 'FREQUENCY'])) %>%
  mutate(Survivals = FREQUENCY - DEATHS) %>%
  select(POPULATION, DEATHS, Survivals) %>%
  column_to_rownames(var = "POPULATION") %>%
  as.matrix()

fisher.test(endo_data)
fisher.test(open_data)
fisher.test(all_data)
```

Check for 10yr mortality rates among elective endo cases:
```{r}
df_race <- lara_bymonth %>% 
  quick_filter(c('DEATHS','FREQUENCY'), c('WHITE','BLACK','"PARDA"','ASIAN'),'ELECTIVE',c('OPEN','ENDO')) %>% 
  group_by(VARIABLE, POPULATION, URGENCY, TYPE) %>% 
  summarise(TOTAL = sum(VALUE)) %>% 
  ungroup()

endo_data <- df_race %>%
  filter(TYPE == 'ENDO', URGENCY == 'ELECTIVE') %>%
  spread(key = VARIABLE, value = TOTAL) %>%
  mutate(ALIVE = FREQUENCY - DEATHS) %>%
  select(POPULATION, DEATHS, ALIVE) %>%
  column_to_rownames(var = "POPULATION") %>%
  as.matrix()

open_data <- df_race %>%
  filter(TYPE == 'OPEN', URGENCY == 'ELECTIVE') %>%
  spread(key = VARIABLE, value = TOTAL) %>%
  mutate(ALIVE = FREQUENCY - DEATHS) %>%
  select(POPULATION, DEATHS, ALIVE) %>%
  column_to_rownames(var = "POPULATION") %>%
  as.matrix()

all_data <- df_sex %>%
  filter(URGENCY == 'ELECTIVE') %>%
  group_by(POPULATION) %>%
  summarize(DEATHS = sum(TOTAL[VARIABLE == 'DEATHS']),
            FREQUENCY = sum(TOTAL[VARIABLE == 'FREQUENCY'])) %>%
  mutate(ALIVE = FREQUENCY - DEATHS) %>%
  select(POPULATION, DEATHS, ALIVE) %>%
  column_to_rownames(var = "POPULATION") %>%
  as.matrix()

fisher.test(endo_data)
fisher.test(open_data)
fisher.test(all_data)
```

```{r, echo=FALSE, message=FALSE}
end_time <- Sys.time()
print(paste('Time taken:',end_time - start_time))
```

